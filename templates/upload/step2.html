<div class="card">
  <div class="card-header">
    <h2>Step 2: Map CSV Columns to Schema</h2>
  </div>

  <div class="card-body">
    <!-- Error Display -->
    <div x-show="$store.schema.state.error" 
         class="alert alert-danger" 
         x-text="$store.schema.state.error"
         x-cloak></div>

    <!-- Validation Errors -->
    <div x-show="$store.schema.state.validationErrors.length > 0" 
         class="alert alert-warning"
         x-cloak>
      <h5 class="alert-heading">Validation Errors</h5>
      <template x-for="error in $store.schema.state.validationErrors" :key="error">
        <p class="mb-0" x-text="error"></p>
      </template>
    </div>

    <!-- Schema Selection -->
    <div class="form-group mb-4">
      <label class="form-label">Select Schema Type:</label>
      <select class="form-select"
              x-model="$store.schema.state.selectedSchema"
              @change="$store.schema.selectSchema($event.target.value)">
        <option value="">Choose a schema...</option>
        <template x-for="schema in $store.schema.state.schemas">
          <option :value="schema" 
                  x-text="schema"
                  :selected="schema === $store.schema.state.selectedSchema"></option>
        </template>
      </select>
    </div>

    <!-- Position Format Toggle -->
    <div x-show="$store.schema.state.hasPositionFields" 
         class="form-group mb-4"
         x-cloak>
      <div class="form-check">
        <input type="checkbox"
               class="form-check-input"
               id="mergedPositions"
               :checked="$store.schema.state.useMergedPositions"
               @change="$store.schema.togglePositionFormat()">
        <label class="form-check-label" for="mergedPositions">
          Use merged position columns (single column containing [x,y,z])
        </label>
      </div>
    </div>

    <!-- Column Mapping -->
    <div x-show="$store.schema.state.selectedSchema" 
         class="mb-4"
         x-cloak>
      <h4>Map CSV Columns to Schema Fields</h4>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Schema Field</th>
              <th>Type</th>
              <th>Required</th>
              <th>CSV Column</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="field in $store.schema.state.displayFields" :key="field.name">
              <tr :class="{
                'table-warning': field.required && !$store.schema.state.columnMapping[field.name],
                'table-info': field.isGeometry,
                'table-success': $store.schema.state.columnMapping[field.name]
              }">
                <td>
                  <span x-text="field.name"></span>
                  <span x-show="field.isGeometry" 
                        class="badge bg-info ms-1">Position</span>
                </td>
                <td x-text="field.type"></td>
                <td>
                  <span x-show="field.required" 
                        class="badge bg-danger">Required</span>
                  <span x-show="!field.required" 
                        class="badge bg-secondary">Optional</span>
                </td>
                <td>
                  <select class="form-select"
                          :value="$store.schema.state.columnMapping[field.name]"
                          @change="$store.schema.updateColumnMapping(field.name, $event.target.value)">
                    <option value="">Select column...</option>
                    <template x-for="column in $store.schema.state.csvColumns" :key="column">
                      <option :value="column" 
                             x-text="column"
                             :selected="$store.schema.state.columnMapping[field.name] === column"></option>
                    </template>
                  </select>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Ignored Columns Display -->
    <div x-show="$store.schema.state.ignoredColumns.length > 0" 
         class="mt-4"
         x-cloak>
      <h5>Ignored Columns</h5>
      <p class="text-muted">The following columns from your CSV will not be used:</p>
      <div class="d-flex flex-wrap gap-2">
        <template x-for="column in $store.schema.state.ignoredColumns" :key="column">
          <span class="badge bg-secondary" x-text="column"></span>
        </template>
      </div>
    </div>
  </div>

  <div class="card-footer">
    <div class="d-flex justify-content-between">
      <button class="btn btn-secondary" @click="$store.wizard.prev()">
        ← Back
      </button>
      <div>
        <button class="btn btn-warning me-2" @click="$store.schema.reset()">
          Reset
        </button>
        <button class="btn btn-primary"
                @click="await $store.schema.handleNext() && $store.wizard.next()"
                :disabled="!$store.schema.isValid()">
          Next →
        </button>
      </div>
    </div>
  </div>
</div>