version: '3'
services:
    db:
      image: mdillon/postgis
      env_file:
        - ./.env.dev
      ports:
        - 5432:5432
      volumes:
        - postgres_data:/var/lib/postgresql/data
        - ./entrypoint.sh:/var/lib/postgresql/entrypoint.sh
      healthcheck:
        test: "pg_isready -h localhost -p 5432 -q -U postgres"
        interval: 3s
        timeout: 5s
        retries: 5
    adminer:
      image: adminer
      ports:
        - 8080:8080
      links:
        - db
    materialize:
      image: 'materialize:tag'
      build:
        context: .
        dockerfile: Dockerfile
      ports:
        - 80:80
      volumes:
        - ./app:/app
      env_file:
        - ./.env.dev 
      depends_on:
        - db
    celery-process:
      image: 'materialize:tag'
      command: ["celery", "worker", "--app=app.main.celery", "--concurrency=1", "--hostname=worker.process@%h", "--queues=process", "--loglevel=INFO"] # celery worker -A app.main.celery --loglevel=info
      env_file:
        - ./.env.dev 
      depends_on:
        - materialize 
        - redis  
    celery-eventlets:
      image: 'materialize:tag'
      env_file:
        - ./.env.dev   
      command: ["celery", "worker", "--app=app.main.celery","--pool=threads", "--concurrency=100", "--hostname=worker.threads@%h", "--queues=threads", "--loglevel=DEBUG"]
      depends_on:
        - materialize
        - redis
    redis:
      image: redis:5.0.4-alpine
      command: ["redis-server"]
      ports:
        - 6379:6379 
    flower:
      image: mher/flower
      environment:
        - FLOWER_PORT=5555
      command: ["flower", "--broker=redis://redis:6379/0", "--port=5555"]  
      ports:
        - 5555:5555
      depends_on: 
        - celery-eventlets
        - celery-process

volumes:
  postgres_data:
  redis:
